---
title: "Trabalho 3 - Modelos Lineares Generalizados"
author: "Vítor Pereira"
header-includes:
   - \usepackage[brazil]{babel}
   - \usepackage{bm}
geometry: left=1.7cm, right=1.7cm, top=3.33cm, bottom=3.2cm
output:
  bookdown::pdf_document2:
editor_options:
  chunk_output_type: console
indent: true
toc: false
---

```{r setup,include=F}

options(digits=3)  #Arrendodamento
options(scipen=999)
ggplot2::theme_set(ggplot2::theme_minimal()) #Tema dos gráficos produzidos no ggplot2
knitr::opts_chunk$set(echo=F,message=F,warning=F,fig.pos = 'H',fig.align = 'center',fig.width=7.8, fig.height=4.85)
scale_fill_discrete = \(...) ggplot2::scale_fill_brewer(... , palette="Set2") #Fixa a scale do fill dos gráficos do ggplot2
turbina = scan("turbina.dat", list(tipo=0, tempo=0))
turbina$tipo = factor(turbina$tipo)
turbina <- dplyr::bind_cols(tempo = turbina$tempo, tipo = turbina$tipo)
library(tidyverse)
library(patchwork)
turbina %>% mutate(n = 1:length(tipo)) -> turbina
```

```{r functions}
d=function(df,v1,v2,px){
  df %>% 
    ggplot(aes({{v1}},{{v2}})) +
    geom_point(size=2.1,color="red")+
    ggrepel::geom_text_repel(aes(label=n),size=2.8,point.padding = 0.3)
}

graph<-function(df,l){
  df %>% 
    as_tibble() %>% 
      ggplot(aes(as.numeric(row.names(df  %>% as_tibble())),value))+
      geom_point(color = 'red')+
      geom_hline(yintercept=l, linetype="dashed", color = "red")+
      geom_hline(yintercept=-l, linetype="dashed", color = "red")+
      labs(x="Índice")
    
}

fit2df<-function(fit) {
  summary(fit) |>
    (\(x) x$coefficients)() |>
    data.frame() |>
    round(3) |>
    mutate(P.valor = ifelse(
      `Pr...t..` < 0.001,"<0.001*",
      ifelse(`Pr...t..` < 0.05, paste0(`Pr...t..`, '*', sep = ''), `Pr...t..`))) |>
    select(-`Pr...t..`,
      "Estimativa" = "Estimate",
      "Desvio padrão" = "Std..Error",
      "Estatística t" = "t.value"
    )
}




dffts<-function(fitn,fitg,lab1,lab2){
    n = length(fitn$fitted.values)
  dffits(fitn) %>% 
 graph(2*sqrt(fitn$rank / n))+
  labs(title={{lab1}},y="DFfits")+
  dffits(fitg) %>% 
 graph(2*sqrt(fitn$rank / n))+
  labs(title={{lab2}},y="DFfits")
}

resid<-function(residuon,residuog,lab1,lab2){
 residuon %>% 
  graph(3)+
  geom_hline(yintercept = 0, linetype="dotted", color = "red")+
  labs(title={{lab1}},y="Resíduo")+
  residuog %>% 
  graph(3)+
  geom_hline(yintercept = 0, linetype="dotted", color = "red")+
  labs(title={{lab2}},y="Resíduo") 
}
cook<-function(fitn,fitg,lab1,lab2){
  n = length(fitn$fitted.values)
  cooks.distance(fitn) %>% 
  graph(4/(n-fitn$rank ))+ ggrepel::geom_text_repel(aes(label=turbina$n),size=2.8,point.padding = 0.3) +
  labs(title={{lab1}},y="Distância de Cook")+
  cooks.distance(fitg) %>% 
  graph(4/(n-fitg$rank ))+
  labs(title={{lab2}},y="Distância de Cook")
}

dffts1<-function(fitn,lab1){
  n = length(fitn$fitted.values)
  dffits(fitn) %>% 
 graph(2*sqrt(fitn$rank / n))+
  labs(title={{lab1}},y="DFfits")
}

resid1<-function(residuon,lab1){
 residuon %>% 
  graph(3)+
  geom_hline(yintercept = 0, linetype="dotted", color = "red")+
  labs(title={{lab1}},y="Resíduo")
}
cook1<-function(fitn,lab1){
    n = length(fitn$fitted.values)
  cooks.distance(fitn) %>% 
  graph(4/(n-fitn$rank ))+
  labs(title={{lab1}},y="Distância de Cook")
  
}

alavanca1 <- function(fit){
  h_bar=fit$rank/length(fit$fitted.values)
  hatvalues(fit) %>%
  graph(3*h_bar)+
  labs(title="Alavancagem",y="Medida de Alavancagem")
}

alavanca <- function(fit,fit2,lab1,lab2){
  h_bar=fit$rank/length(fit$fitted.values)
  h_bar2=fit2$rank/length(fit2$fitted.values)
  hatvalues(fit) %>%
  graph(3*h_bar)+
  labs(title={{lab1}},y="Medida de Alavancagem") +
  hatvalues(fit2) %>%
  graph(3*h_bar2)+
  labs(title={{lab2}},y="Medida de Alavancagem")
    
}
```

# Modelando o banco de dados com a Gama

## Primeiro Ajuste
```{r}
glm(tempo ~ tipo, family = Gamma(link = "log"), data = turbina) %>%
  fit2df() %>%
    mypdf1::pdf1_tbl("Primeiro Ajuste - Gama")
```
Notamos, que os tipos não são completamente significativos, assim realizaremos junções buscando que as variáveis dummies sejam significativas.

## Segundo Ajuste

```{r}
turbina %>% 
  mutate(tipo = case_when(as.numeric(tipo) == 3 ~ 4, TRUE ~ as.numeric(tipo))) %>%
  mutate(tipo = factor(tipo)) %>%
  glm(tempo ~ tipo, family = Gamma(link = "log"), data = .) %>%
  fit2df() %>%
    mypdf1::pdf1_tbl("Segundo Ajuste - Gama")
```
Juntamos o tipo 3 e 4, mas ainda não obtivemos significância em todos os tipos.

## Terceiro Ajuste
```{r}
turbina %>% 
  mutate(tipo = case_when(as.numeric(tipo) == 3 ~ 4, as.numeric(tipo) == 4 ~ 1, TRUE ~ as.numeric(tipo))) %>% 
  mutate(tipo = case_when(as.numeric(tipo) == 4 ~ 1, TRUE ~ as.numeric(tipo)))  %>%
  mutate(tipo = factor(tipo)) %>%
  glm(tempo ~ tipo, family = Gamma(link = "log"), data = .) -> fit1 
fit1 %>%
  fit2df() %>%
    mypdf1::pdf1_tbl("Terceiro Ajuste - Gama")
```
No entanto, aglutinando os tipos 1,3 e 4, temos que todas as variáveis dummies são significativas.


## Modelando com o banco de dados com a normal inversa

```{r}
glm(tempo ~ tipo, inverse.gaussian(link = "1/mu^2"), data = turbina) %>%
  fit2df() %>%
    mypdf1::pdf1_tbl("Primeiro Ajuste - Gama")
glm(tempo ~ tipo, inverse.gaussian(link = "log"), data = turbina) %>%
  fit2df() %>%
    mypdf1::pdf1_tbl("Primeiro Ajuste - Gama")
```

```{r}
turbina %>% 
  mutate(tipo = case_when(as.numeric(tipo) == 3 ~ 4, TRUE ~ as.numeric(tipo))) %>%
  mutate(tipo = factor(tipo)) %>%
  glm(tempo ~ tipo, inverse.gaussian(link = "1/mu^2"), data = .) %>%
  fit2df() %>%
    mypdf1::pdf1_tbl("Primeiro Ajuste - Gama")
turbina %>% 
  mutate(tipo = case_when(as.numeric(tipo) == 3 ~ 4, TRUE ~ as.numeric(tipo))) %>%
  mutate(tipo = factor(tipo)) %>%
  glm(tempo ~ tipo, inverse.gaussian(link = "log"), data = .) %>%
  fit2df() %>%
    mypdf1::pdf1_tbl("Primeiro Ajuste - Gama")
```

```{r}
turbina %>% 
  mutate(tipo = case_when(as.numeric(tipo) == 3 ~ 4, TRUE ~ as.numeric(tipo))) %>%
  mutate(tipo = case_when(as.numeric(tipo) == 4 ~ 1, TRUE ~ as.numeric(tipo))) %>%
  mutate(tipo = factor(tipo)) %>%
  glm(tempo ~ tipo, inverse.gaussian(link = "1/mu^2"), data = .) -> fit2
fit2 %>%  
fit2df() %>%
    mypdf1::pdf1_tbl("Primeiro Ajuste - Gama")
turbina %>% 
  mutate(tipo = case_when(as.numeric(tipo) == 3 ~ 4, TRUE ~ as.numeric(tipo))) %>%
  mutate(tipo = case_when(as.numeric(tipo) == 4 ~ 1, TRUE ~ as.numeric(tipo))) %>%
  mutate(tipo = factor(tipo)) %>%
  glm(tempo ~ tipo, inverse.gaussian(link = "log"), data = .) -> fit3
  fit3 %>%
  fit2df() %>%
    mypdf1::pdf1_tbl("Primeiro Ajuste - Gama")
```

# Análise de Influência

## Ajuste com a Gama

### Resíduos deviances vs indices

```{r}
residuo1 <- rstudent(fit1)
resid1(residuo1, "Resíduos do Modelo Gamma")
```

### Envelope Simulado

```{r}
hnp::hnp(fit1, resid.type="deviance", halfnormal = F)
```

### Distância de Cook

```{r}
cook1(fit1, "Distância do Modelo Gamma") +
    ggrepel::geom_text_repel(aes(label=turbina$n, ),size=2.8,point.padding = 0.3)

```

### Alavancagem
```{r}
alavanca1(fit1)
```

### Conclusão

\subsection{Ajuste com a Normal inversa com link $\dfrac{1}{\mu^2}$ e link $\log$} 


### Resíduos deviances vs indices
```{r}
residuo2 <- residuals(fit2,type="deviance")
residuo3 <- residuals(fit3,type="deviance")
resid(residuo2, residuo3, "Resíduos do Modelo Normal Inversa Canônico", "Resíduos do Modelo Normal Inversa log" )
```
### Envelope Simulado

```{r, results = F, fig.show='hide'}
par(mfrow = c(1, 2))
g1 <- hnp::hnp(fit2, resid.type="deviance", halfnormal = F)
hnp::hnp(fit3, resid.type="deviance", halfnormal = F)
G1 <- with(g1, data.frame(x, lower, upper, median, residuals))

```

```{r}
G1 %>%
ggplot(aes(x)) +
  geom_point(aes(y = residuals)) +
  geom_line(aes(y = lower)) +
  geom_line(aes(y = upper)) +
  geom_line(aes(y = median), linetype = "dashed")
```


### Distância de Cook

```{r}
cook(fit2, fit3, "Distância do Modelo Normal Inversa Canônico", "Distância do Modelo Normal Inversa log") +
    ggrepel::geom_text_repel(aes(label=turbina$n),size=2.8,point.padding = 0.3)
```

### Alavancagem


```{r}
alavanca(fit2, fit3, "Açavancagem do Modelo Normal Inversa Canônico", "Alavancagem do Modelo Normal Inversa log") 
```


### Conclusão
